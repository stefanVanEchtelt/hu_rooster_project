<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="my-day">
    <template>
        <style>
            .day {
                float: left;
                width: 12%;
            }
            table {
                border-collapse: collapse;
                table-layout: fixed;
                margin-right: 50px;
            }
            table, th, td {
                border: 1px solid lightgrey;
                height: 10px;
                width: 100%;
            }
            th {
                height: 40px;
                display: block;
                font-size: 0.9em;
            }
            td{
                height: 35px;
                width: 2000px;
                text-align: center;
            }
        </style>

        <div class="day">
          <template is="dom-if" if="{{i_loaded}}">
              <table>
              <tr><th>{{ day_name }} <br> {{ datum }}</th><tr>
              <template is="dom-repeat" items="{{times}}" as="time">
                <template is="dom-if" if="{{isErLesOm(time)}}">
                  <tr>
                    <td>{{getLesOpTijd(time)}}</td>
                  </tr>
                </template>
                <template is="dom-if" if="{{!isErLesOm(time)}}">
                  <tr>
                    <td></td>
                  </tr>
                </template>
              </template>
            </table>
            </template>
        </div>

        <iron-ajax
          id="ajax_lessen_ophalen"
          method="POST"
          url="/rooster/dag/ophalen"
          handle-as="json"
          on-response="_lessen_ophalen_response_handler">
        </iron-ajax>

    </template>

    <script>
        Polymer({
            is: 'my-day',
            properties: {
              datum: {
                type: String,
                value: "",
              },
              dayName: {
                type: String,
                value: "",
              },
              c_visible: {
                type: Boolean,
                value: false,
                observer: '_initializing',
              },
              i_loaded: {
                type: Boolean,
                value: false,
              },
              times: {
                type: Array,
                value: [],
              },
              lessen: {
                type: Array,
                value: [],
              }
            },

            isErLesOm: function (tijd) {
              let found = false;
              this.lessen.forEach((les) => {
                if (les.start_tijd <= tijd && les.eind_tijd > tijd) {
                  found = true;
                }
              });

              return found;
            },

            getLesOpTijd: function (tijd) {
              let found = false;
              this.lessen.forEach((les) => {
                if (les.start_tijd <= tijd && les.eind_tijd > tijd) {
                  found = les;
                }
              });

              return found.cursuscode;
            },

            _initializing: function() {
              if (this.c_visible) {
                this._ajax_lessen_ophalen();
              }
            },

            _ajax_lessen_ophalen: function() {
              this.$.ajax_lessen_ophalen.contentType="application/json";
              this.$.ajax_lessen_ophalen.body = {
                "klascode": "TICT-SIE-V1E",
                "datum": "2019-02-15"
              };
              this.$.ajax_lessen_ophalen.generateRequest();
            },

            _lessen_ophalen_response_handler: function(request) {
              this.times = this.getTimes("06:00", "22:00");
              this.lessen = request.detail.response;
              this.i_loaded = true;
            },

            getTimes: function(from, until) {
              //"01/01/2001" is just an arbitrary date
              var until = Date.parse("01/01/2001 " + until);
              var from = Date.parse("01/01/2001 " + from);
              //*2 because because we want every 30 minutes instead of every hour
              var max = (Math.abs(until-from) / (60*60*1000))*2;
              var time = new Date(from);
              var hours = [];
              for(var i = 0; i <= max; i++){
                  //doubleZeros just adds a zero in front of the value if it's smaller than 10.
                  var hour = this.doubleZeros(time.getHours());
                  var minute = this.doubleZeros(time.getMinutes());
                  hours.push(hour+":"+minute);
                  time.setMinutes(time.getMinutes()+30);
              }
              return hours;
            },

            doubleZeros: function(d) {
              return (d < 10) ? '0' + d.toString() : d.toString();
            }
        });
    </script>
</dom-module>
